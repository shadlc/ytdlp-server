<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="no-referrer">
    <title>Youtube Download Plus</title>
    <link rel="shortcut icon" href="static/favicon.png"/>
    <style>
      @media (max-width: 600px) {
        input {
          width: 90%;
        }
        .video-head {
          margin: 0 auto;
          max-width: 50% !important;
        }
        .video-card, .video-child-card {
          flex-direction: column !important;
        }
        .video-details {
          margin-left: unset !important;
        }
      }
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track
      {
        width: 6px;
        border-radius:10px;
        margin: 6px;
      }
      ::-webkit-scrollbar-thumb {
        width: 6px;
        border-radius: 10px;
        border: 3px solid transparent;
        box-shadow: inset 0 0 6px gray;
      }
      ::-webkit-scrollbar-thumb:hover {
        box-shadow: inset 0 0 10px gray;
      }
      html, body {
        width: 100%;
        margin: 0;
      }
      p {
        margin: 0;
      }
      a {
        text-decoration: none;
        cursor: pointer;
      }
      summary {
        padding: 0.2rem 1.5rem;
        text-align: start;
        cursor: pointer;
      }
      details:has(div:empty) {
        display: none;
      }
      #url_input {
        font-size: larger;
        min-width: 60%;
        border: 2px solid black;
        border-radius: 0.5rem;
        padding: 0.2rem 0.5rem;
      }
      .hide {
        display: none !important;
      }
      .center{
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      .container {
        width: 100%;
        max-width: 1200px;
        text-align: center;
      }
      .btn-group {
        margin: 0.4rem;
      }
      .btn {
        display: inline-block;
        width: fit-content;
        height: fit-content;
        text-align: center;
        padding: 0.2rem 0.5rem;
        margin: 0.2rem;
        border: 2px solid black;
        border-radius: 0.5rem;
        text-decoration: none;
        color: black;
        transform-origin: 50% 50%;
        transition: all 0.2s ease;
      }
      .btn:hover:not(:disabled) {
        cursor: pointer;
      }
      .btn:active:not(:disabled) {
        transform: scale(0.9);
      }
      .btn:disabled {
        cursor: not-allowed;
      }

      .list {
        display: block;
        width: fit-content;
        border: none;
        margin: 0 auto;
        overflow-y: auto;
        flex-direction: column;
      }
      .list:has(.card:nth-child(2)) {
        max-height: 100vh;
        border: 2px solid black;
        border-radius: 0.5rem;
      }
      .video-card {
        position: relative;
        display: flex;
        width: 80vw;
        max-width: 1000px;
        margin: 0.5rem;
        padding: 0.5rem;
        border: 2px solid black;
        border-radius: 0.5rem;
        flex-direction: row;
        text-align: start;
      }
      .video-playlist-card {
        position: relative;
        display: flex;
        width: 80vw;
        max-width: 1000px;
        margin: 0.5rem;
        padding: 0.5rem;
        border: 2px solid black;
        border-radius: 0.5rem;
        flex-direction: column;
      }
      .video-child-card {
        position: relative;
        display: flex;
        margin-top: 0.5rem;
        padding: 0.2rem;
        border-top: 2px solid black;
        text-align: start;
      }
      .video-info-list .btn {
        display: unset !important;
      }
      
      .video-head {
        display: flex;
        max-width: 10rem;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .video-head img {
        display: inline-block;
        width: 100%;
        border-radius: 5%;
        object-fit: scale-down;
      }
      .video-details {
        display: flex;
        margin-left: 2rem;
        flex-direction: column;
        justify-content: center;
      }
    </style>
  </head>
  <body class="center">
    <div class="container">
      <h1><a href="https://github.com/yt-dlp/yt-dlp">yt-dlp</a></h1>
      <div>
        <input type="text" id="url_input" placeholder="粘贴URL并回车直接下载">
      </div>
      <div class="btn-group">
        <input class="btn btn-request" type="button" onclick="video_query()" value="查询详情">
        <input class="btn btn-request" type="button" onclick="video_add()" value="下载视频">
      </div>
      <div class="search-notify"></div>
      <details open>
        <summary>视频详情 <a href="javascript:;" onclick="video_query_list_clear()">清空</a></summary>
        <div class="list center video-info-list"></div>
      </details>
      <details open>
        <summary>下载列表 <a href="javascript:;" onclick="video_download_list_clear()">清空</a></summary>
        <div class="list center video-downloading-list"></div>
      </details>
      <details>
        <summary>历史记录 <a href="javascript:;" onclick="video_history_list_clear()">清空</a></summary>
        <div class="list center video-history-list"></div>
      </details>
    </div>
  </body>
  <script>
    //let host = "http://10.0.0.2:8848/" 
    let host = ""
    let infoUrl = host + "info?url=";
    let downloadUrl = host + "download?url=";
    let clearDownloadUrl = host + "clear_download";
    let clearHistoryUrl = host + "clear_history";
    let statusUrl = host + "status";
    let historyUrl = host + "history";
    
    let requesting = false;
    let offline = false;
    let downloading_count = 0;
    let queryTimeout = null;
    let oldStatus = null;

    let url_input = document.getElementById("url_input");
    url_input.addEventListener("keydown", (e)=>{
      if (e.keyCode == "13" && !requesting) {
        let url = url_input.value;
        requesting_mode(true);
        document.querySelector(".search-notify").innerHTML = "正在添加至下载列表...";
        get(downloadUrl + url,(e)=>{
          query_download();
          requesting_mode(false);
        });
      }
    })

    function isJson(str) {
    try {
      JSON.parse(str);
    } catch(e) {
      return false;
    }
      return true;
    }
    function get(url, callback, user=true){
      let ajax = new XMLHttpRequest();
      ajax.open("GET", url, true);
      ajax.send();
      ajax.onreadystatechange=()=>{
        if (ajax.readyState == 4){
          data = {};
          if (ajax.status==200){
            data = JSON.parse(ajax.responseText);
            let div = "<p>" + data.status + "</p>"
            if (user) {
              document.querySelector(".search-notify").innerHTML = div;
            }
            if (offline) {
              offline = false;
              query_history(true);
            }
            if (typeof callback === 'function') {
              callback(data);
            }
          } else if(ajax.status == 0 || ajax.status == 404 || ajax.status == 502) {
            offline = true;
            document.querySelector(".search-notify").innerHTML = "无法连接至yt-dlp！";
            if (typeof callback === 'function') {
              callback(null);
            }
          } else if (ajax.status != 200) {
            data.status = "内部错误！"
            if (isJson(ajax.responseText)) {
              data = JSON.parse(ajax.responseText);
            }
            let div = "<p>" + data.status + "</p>"
            if (user) {
              document.querySelector(".search-notify").innerHTML = div;
            }
            if (typeof callback === 'function') {
              callback(data);
            }
          }
        }
      }
    }
    function requesting_mode(status) {
      request_btn = document.querySelectorAll('.btn-request');
      if (status) {
        request_btn.forEach((e)=>{
          e.disabled = true;
        });
      } else {
        request_btn.forEach((e)=>{
          e.disabled = false;
        });
      }
    }
    function formatSize(value) {
      if (null == value || value == "") {
          return "0 Bytes";
      }
      let unitArray = new Array("B","KB","MB","GB","TB","PB","EB","ZB","YB");
      let index = 0;
      let srcSize = parseFloat(value * 1.1);
      index = Math.floor(Math.log(srcSize) / Math.log(1024));
      let size = srcSize/Math.pow(1024, index);
      size = size.toFixed(2);
      return size + unitArray[index];
    }
    function formatSeconds(value) {
      let hours = Math.floor(value / 3600);
      let minutes = Math.floor((value - (hours * 3600)) / 60);
      let seconds = Math.floor(value - (hours * 3600) - (minutes * 60));
      if (minutes < 10 && hours != 0) {
        minutes = "0" + minutes;
      }
      if (seconds < 10 && minutes != 0) {
        seconds = "0" + seconds;
      }
      let timeString = hours + ':' + minutes + ':' + seconds;
      if (hours == 0 && minutes == 0) {
        timeString = seconds;
      } else if (hours == 0) {
        timeString = minutes + ':' + seconds;
      }
      return timeString;
    }

    function createDiv(data){
      div = ""
      if (data.type == 'video') {
        div = createVideoDiv(data)
      } else {
        div = createPlaylistDiv(data)
      }
      return div
    }
    function createVideoDiv(data){
      div = `
        <div class="card video-card">
          <div class="video-head">
            <img src="`+data.thumbnail+`">
            <input class="btn btn-request hide" type="button" onclick="video_add('`+data.url+`')" value="下载视频">
          </div>
          <div class="video-details">
            <a href="`+data.url+`">`+data.title+`</a>
            <p>分辨率: `+data.resolution+`</p>
            <p>预估大小: `+formatSize(data.size)+`</p>
            <p>播放时长: `+formatSeconds(data.duration)+`</p>
            <p>视频格式: `+data.ext+`</p>
            <p>来源: `+data.site+' '+data.uploader+`</p>
          </div>
        </div>
      ` 
      return div
    }
    function createPlaylistDiv(data){
      totalSize = 0;
      totalDuration = 0;
      childDiv = "";
      let d = data.entires;
      for (let i in d) {
        totalSize += d[i].size;
        totalDuration += d[i].duration;
        childDiv += `
          <div class="video-child-card">
            <div class="video-head">
              <img src="`+d[i].thumbnail+`">
              <input class="btn btn-request hide" type="button" onclick="video_add('`+d[i].url+`')" value="下载单集">
            </div>
            <div class="video-details">
              <a href="`+d[i].url+`">`+d[i].title+`</a>
              <p>分辨率: `+d[i].resolution+`</p>
              <p>预估大小: `+formatSize(d[i].size)+`</p>
              <p>视频时长: `+formatSeconds(d[i].duration)+`</p>
              <p>视频格式: `+d[i].ext+`</p>
              <p>来源: `+d[i].site+' '+d[i].uploader+`</p>
            </div>
          </div>
        `
      }
      let isOpen = '';
      if (d.length <= 3) {
        isOpen = 'open';
      }
      div = `
        <div class="card video-playlist-card">
          <div>
            <a href="`+data.url+`">`+data.title+`</a>
            <p>集数: `+data.count+` | 总大小: `+formatSize(totalSize)+` | 总时长: `+formatSeconds(totalDuration)+`</p>
            <input class="btn btn-request hide" type="button" onclick="video_add('`+data.url+`')" value="下载合辑">
            <details `+isOpen+`>
              <summary>合辑详情</summary>
              <div>`+childDiv+`</div>
            </details>
          </div>
        </div>
      ` 
      return div
    }
    
    function show_video_info(data){
      if (data != ""){
        document.querySelector(".video-info-list").insertAdjacentHTML("AfterBegin", createDiv(data));
      }
    }
    function show_video_card(data, element){
      document.querySelector(element).innerHTML = "";
      if (data != ""){
        for(let key in data) {
          document.querySelector(element).insertAdjacentHTML("AfterBegin", createDiv(data[key]));
        }
      }
    }

    function video_query(url){
      requesting_mode(true);
      document.querySelector(".search-notify").innerHTML = "正在获取视频详情...";
      if (url == null) {
        url = document.getElementById("url_input").value;
      }
      get(infoUrl + url,(e)=>{
        if (e != null) {
          show_video_info(e.data);
        }
        requesting_mode(false);
      });
    }
    function video_add(url){
      requesting_mode(true);
      document.querySelector(".search-notify").innerHTML = "正在添加至下载列表...";
      if (url == null) {
        url = document.getElementById("url_input").value;
      }
      get(downloadUrl + url,(e)=>{
        query_download();
        requesting_mode(false);
      });
    }

    function query_history(status=false){
      get(historyUrl, (he)=>{
        if (he != null) {
          show_video_card(he.data, ".video-history-list");
        }
      }, status);
    }
    function query_download(status=false){
      clearTimeout(queryTimeout);
      get(statusUrl, (de)=>{
        if (de == null){
          queryTimeout = setTimeout(query_download, 3000);
          return;
        }
        if (de.data == null){
          queryTimeout = setTimeout(query_download, 3000);
        } else {
          queryTimeout = setTimeout(query_download, 1000);
        }
        downloading_list = document.querySelector(".video-downloading-list");
        if (oldStatus != de.data){
          show_video_card(de.data, ".video-downloading-list");
          oldStatus = de.data;
        }
        if (downloading_count != downloading_list.children.length){
          downloading_count = downloading_list.children.length;
          document.querySelector(".search-notify").innerHTML = "<p>" + de.status + "</p>";
          query_history();
        }
      }, status);
    }
    query_history();
    query_download();

    function video_query_list_clear(){
      document.querySelector(".video-info-list").innerHTML = "";
    }
    function video_download_list_clear(){
      let flag = confirm("该操作会清空下载列表(由于ytdlp限制无法停止正在下载，只是清空记录)，是否继续？");
      if (flag) {
        let url = document.getElementById("url_input").value;
        get(clearDownloadUrl);
        query_download();
      }
    }
    function video_history_list_clear(){
      let flag = confirm("该操作会清空下载历史记录，是否继续？");
      if (flag) {
        let url = document.getElementById("url_input").value;
        get(clearHistoryUrl);
        query_history();
      }
    }

  </script>
</html>